<!DOCTYPE html>
<html lang="en">

<head>
	<title>Cardboard Example</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			margin: 0px;
			overflow: hidden;
		}

		#example {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
		}
	</style>
</head>

<body>
	<div id="example"></div>



	<script type="application/x-glsl" id="sky-vertex">
		varying vec2 vUV; void main() { vUV = uv; vec4 pos = vec4(position, 10.0); gl_Position = projectionMatrix * modelViewMatrix * pos; }
	</script>

	<script type="application/x-glsl" id="sky-fragment">
		uniform sampler2D texture; varying vec2 vUV; void main() { vec4 sample = texture2D(texture, vUV); gl_FragColor = vec4(sample.xyz, sample.w); }
	</script>

	<script src="js/third-party/threejs/three.js"></script>
	<script src="js/third-party/threejs/StereoEffect.js"></script>
	<script src="js/third-party/threejs/DeviceOrientationControls.js"></script>
	<script src="js/third-party/threejs/OrbitControls.js"></script>
	<script src="js/third-party/threejs/OBJLoader.js"></script>
	<script src="js/third-party/threejs/DDSLoader.js"></script>
	<script src="js/third-party/threejs/MTLLoader.js"></script>
	<script src="js/third-party/threejs/OBJMTLLoader.js"></script>

	<script>
		var camera, scene, renderer;
		var effect, controls;
		var element, container;

		var clock = new THREE.Clock();

		//helper function
		function getRandomInt(min, max) {
			return Math.floor(Math.random() * (max - min)) + min;
		}

		function makeTrees(trees) {
			THREE.Loader.Handlers.add(/\.dds$/i, new THREE.DDSLoader());
			var loader = new THREE.OBJMTLLoader();
			loader.load('models/voxel-tree.obj', 'models/voxel-tree.mtl', function(object) {
				for (var i = 0; i < trees.length; i++) {
					var tree = object.clone();
					tree.castShadow = true;
					tree.translateX(trees[i][0]);
					tree.translateY(-0.9);
					tree.translateZ(trees[i][1]);
					tree.scale.set(6, 6, 6);
					scene.add(tree);
				}
			});
		}

		function makeSnow(scene) {
            var loader = new THREE.TextureLoader();
            loader.load('textures/patterns/snow-ground.jpg', function(texture) {
                texture.wrapS = THREE.RepeatWrapping;
    			texture.wrapT = THREE.RepeatWrapping;
    			texture.repeat = new THREE.Vector2(1024, 1024);
    			texture.anisotropy = renderer.getMaxAnisotropy();

    			var material = new THREE.MeshPhongMaterial({
    				color: 0xffffff,
    				specular: 0xffffff,
    				shininess: 10,
    				shading: THREE.FlatShading,
    				map: texture
    			});

    			var geometry = new THREE.PlaneGeometry(1000, 1000);

    			var mesh = new THREE.Mesh(geometry, material);
    			mesh.rotation.x = -Math.PI / 2;
                mesh.receiveShadow = true;
    			scene.add(mesh);
            });
		};

		function addLights(scene) {
			var light = new THREE.HemisphereLight(0xffffff, 0x000000, 0.6);
			scene.add( light );

			var ambient = new THREE.AmbientLight(0x444444);
			scene.add( ambient );

			var directional = new THREE.DirectionalLight( 0xffeedd, 0.4 );
            directional.position.set(-200, 100, -100);
			directional.target.position.set(30, 0, 10);
            directional.castShadow = true;
            scene.add( directional );
		};

		function addSky(scene) {
            var loader = new THREE.TextureLoader();
            loader.load('textures/patterns/starfield.png', function(texture) {
    			var geometry = new THREE.SphereGeometry(1000, 200, 100),
    				uniforms = {
    					texture: {
    						type: 't',
    						value: texture
    					}
    				},
    				material = new THREE.ShaderMaterial({
    					uniforms: uniforms,
    					vertexShader: document.getElementById('sky-vertex').textContent,
    					fragmentShader: document.getElementById('sky-fragment').textContent
    				}),
    				skybox = new THREE.Mesh(geometry, material);
    			skybox.scale.set(-1, 1, 1);
    			skybox.rotation.order = 'XZY';
    			skybox.renderOrder = 1000.0;
    			scene.add(skybox);
            });
		}

		init();
		animate();

		function init() {
			renderer = new THREE.WebGLRenderer({
				antialias: true,
			});
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMap.enabled = true;

			element = renderer.domElement;
			container = document.getElementById('example');
			container.appendChild(element);

			effect = new THREE.StereoEffect(renderer);

			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.001, 700);
			camera.position.set(0, 8, 0);

			controls = new THREE.OrbitControls(camera, element);
			controls.target.set(
				camera.position.x + 0.1,
				camera.position.y,
				camera.position.z
			);
			controls.noZoom = true;
			controls.noPan = true;

			function setOrientationControls(e) {
				if (!e.alpha) {
					return;
				}

				controls = new THREE.DeviceOrientationControls(camera, true);
				controls.connect();
				controls.update();

				element.addEventListener('click', fullscreen, false);

				window.removeEventListener('deviceorientation', setOrientationControls, true);
			}
			window.addEventListener('deviceorientation', setOrientationControls, true);


			addLights(scene);
			makeSnow(scene);
			addSky(scene);

			var trees = [
				[50, 20],
				[30, 2],
				[25, 10],
				[30, -15],
				[60, -5],
				[-20, 0],
			];

			makeTrees(trees);

			window.addEventListener('resize', resize, false);
			setTimeout(resize, 1);
		}

		function resize() {
			var width = container.offsetWidth;
			var height = container.offsetHeight;

			camera.aspect = width / height;
			camera.updateProjectionMatrix();

			renderer.setSize(width, height);
			effect.setSize(width, height);
		}

		function update(dt) {
			resize();

			camera.updateProjectionMatrix();

			controls.update(dt);
		}

		function render(dt) {
			//uncomment next line and comment second to render in 2D
			renderer.render(scene, camera);
			//effect.render(scene, camera);
		}

		function animate(t) {
			requestAnimationFrame(animate);

			update(clock.getDelta());
			render(clock.getDelta());
		}

		function fullscreen() {
			if (container.requestFullscreen) {
				container.requestFullscreen();
			} else if (container.msRequestFullscreen) {
				container.msRequestFullscreen();
			} else if (container.mozRequestFullScreen) {
				container.mozRequestFullScreen();
			} else if (container.webkitRequestFullscreen) {
				container.webkitRequestFullscreen();
			}
		}
	</script>




</body>

</html>
