<!DOCTYPE html>
<html lang="en">

<head>
	<title>Cardboard Example</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			margin: 0px;
			overflow: hidden;
		}

		#example {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
		}
	</style>
</head>

<body>
	<div id="example"></div>

	<script src="js/third-party/threejs/three.js"></script>
	<script src="js/third-party/threejs/StereoEffect.js"></script>
	<script src="js/third-party/threejs/DeviceOrientationControls.js"></script>
	<script src="js/third-party/threejs/OrbitControls.js"></script>
	<script src="js/third-party/threejs/MTLLoader.js"></script>
	<script src="js/third-party/threejs/OBJMTLLoader.js"></script>

	<script>
		var camera, scene, renderer;
		var effect, controls;
		var element, container;

		var clock = new THREE.Clock();

		function makeTrees(trees) {
			var loader = new THREE.OBJMTLLoader();
			loader.load('models/voxel-tree.obj', 'textures/voxel-tree.mtl', function(object) {
				for (var i = 0; i < trees.length; i++) {
					var tree = object.clone();
					tree.translateX(trees[i][0]);
					tree.translateZ(trees[i][1]);
					/* wireframe mode
					tree.traverse(function(child) {
						if ( child instanceof THREE.Mesh ) {
							child.material.wireframe = true;
						}
					});
					*/
					scene.add(tree);
				}
			});
		}

		function makeSnow(scene) {
            var loader = new THREE.TextureLoader();
            loader.load('textures/patterns/pixel-snow.jpg', function(texture) {
                texture.wrapS = THREE.RepeatWrapping;
    			texture.wrapT = THREE.RepeatWrapping;
    			texture.repeat = new THREE.Vector2(1024, 1024);
    			texture.anisotropy = renderer.getMaxAnisotropy();

    			var material = new THREE.MeshPhongMaterial({
    				map: texture
    			});

    			var geometry = new THREE.PlaneGeometry(200, 200);

    			var mesh = new THREE.Mesh(geometry, material);
    			mesh.rotation.x = -Math.PI / 2;
    			scene.add(mesh);
            });
		};

		function addLights(scene) {
			var light = new THREE.HemisphereLight(0xffffff, 0x000000, 0.8);
			scene.add( light );

			var directional = new THREE.DirectionalLight( 0xffeedd, 0.4 );
            directional.position.set(-200, 100, -100);
			directional.target.position.set(30, 0, 10);
            scene.add( directional );
		};

		function addSky(scene) {
            var loader = new THREE.TextureLoader();
            loader.load('textures/patterns/starfield.png', function(texture) {
    			var geometry = new THREE.SphereGeometry(200, 32, 32),
					material = new THREE.MeshBasicMaterial({
						map: texture,
						side: THREE.BackSide
					}),
    				skybox = new THREE.Mesh(geometry, material);
    			scene.add(skybox);
            });
		}

		init();
		animate();

		function init() {
			renderer = new THREE.WebGLRenderer({
				antialias: true,
			});
            renderer.setSize( window.innerWidth, window.innerHeight );

			element = renderer.domElement;
			container = document.getElementById('example');
			container.appendChild(element);

			effect = new THREE.StereoEffect( renderer );
			effect.eyeSeparation = 1;
			effect.focalLength = 15;

			scene = new THREE.Scene();

			//var fov = ( window.location.hash == '#desktop' ) ? 45 : 90;
			camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.001, 700 );
			camera.position.set(0, 1, 0);

			controls = new THREE.OrbitControls( camera, element );
			controls.target.set(
				camera.position.x + 0.1,
				camera.position.y,
				camera.position.z
			);
			controls.enableZoom = false;
			controls.enablePan = false;

			function setOrientationControls(e) {
				if (!e.alpha) {
					return;
				}

				controls = new THREE.DeviceOrientationControls(camera, true);
				controls.connect();
				controls.update();

				element.addEventListener('click', fullscreen, false);

				window.removeEventListener('deviceorientation', setOrientationControls, true);
			}
			window.addEventListener('deviceorientation', setOrientationControls, true);


			addLights(scene);
			makeSnow(scene);
			addSky(scene);

			var trees = [
				[10, -2],
				[10, 1],
				[5, -3],
				[7, -0.25],
				[5, 3],
				[-5, 0],
			];

			makeTrees(trees);

			window.addEventListener('resize', resize, false);
			setTimeout(resize, 1);
		}

		function resize() {
			var width = container.offsetWidth;
			var height = container.offsetHeight;

			camera.aspect = width / height;
			camera.updateProjectionMatrix();

			renderer.setSize(width, height);
			effect.setSize(width, height);
		}

		function update(dt) {
			resize();

			camera.updateProjectionMatrix();

			controls.update(dt);
		}

		function render(dt) {
			if( window.location.hash == '#desktop' ) {
				renderer.render(scene, camera);
			} else {
				effect.render(scene, camera);
			}
		}

		function animate(t) {
			requestAnimationFrame(animate);

			update(clock.getDelta());
			render(clock.getDelta());
		}

		function fullscreen() {
			if (container.requestFullscreen) {
				container.requestFullscreen();
			} else if (container.msRequestFullscreen) {
				container.msRequestFullscreen();
			} else if (container.mozRequestFullScreen) {
				container.mozRequestFullScreen();
			} else if (container.webkitRequestFullscreen) {
				container.webkitRequestFullscreen();
			}
		}
	</script>




</body>

</html>
